import React from 'react';
import { marked } from 'marked';

interface Message {
  role: 'user' | 'model';
  text: string;
}

interface ChatMessageProps {
  message: Message;
}

// Configure marked to interpret single newlines as <br> tags for better formatting.
marked.setOptions({
  breaks: true,
});

const logoSrc = "data:image/jpeg;base64,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";

const TypingIndicator: React.FC = () => (
    <div className="flex items-center gap-1.5">
        <span className="w-2 h-2 bg-slate-500 rounded-full animate-bounce [animation-delay:-0.3s]"></span>
        <span className="w-2 h-2 bg-slate-500 rounded-full animate-bounce [animation-delay:-0.15s]"></span>
        <span className="w-2 h-2 bg-slate-500 rounded-full animate-bounce"></span>
    </div>
);


export const ChatMessage: React.FC<ChatMessageProps> = ({ message }) => {
  const isModel = message.role === 'model';
  
  const createMarkup = (text: string) => {
    // Basic sanitization for security
    const sanitizedHtml = marked.parse(text);
    return { __html: sanitizedHtml };
  };

  if (isModel) {
    return (
      <div className="flex items-start gap-3">
        <img src={logoSrc} alt="OptiLife Logo" className="w-8 h-8 rounded-full flex-shrink-0 mt-1" />
        <div className="bg-brand-blue-light rounded-lg rounded-tl-none p-4 text-brand-gray flex-1">
          {message.text === '...' ? <TypingIndicator /> : (
            <div className="prose prose-invert prose-sm max-w-none" dangerouslySetInnerHTML={createMarkup(message.text)} />
          )}
        </div>
      </div>
    );
  }

  return (
    <div className="flex justify-end">
      <div className="bg-brand-teal text-white rounded-lg rounded-br-none p-4 max-w-xl">
        <p className="whitespace-pre-wrap">{message.text}</p>
      </div>
    </div>
  );
};